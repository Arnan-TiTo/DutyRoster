generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  userId       String   @id @default(uuid()) @map("user_id")
  username     String   @unique
  passwordHash String   @map("password_hash")
  displayName  String   @map("display_name")
  employeeId   String?  @map("employee_id")
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @default(now()) @updatedAt @map("updated_at")

  employee     Employee? @relation(fields: [employeeId], references: [employeeId])
  roles        UserRole[]
  menuOverrides UserMenuOverride[]
  decidedLeaveRequests LeaveRequest[]
  createdRosterEntries RosterEntry[]
  assignedRosterAssignments RosterAssignment[]

  @@map("users")
}

model Role {
  roleId   String @id @default(uuid()) @map("role_id")
  roleCode String @unique @map("role_code")
  roleName String @map("role_name")

  users UserRole[]
  roleMenus RoleMenu[]

  @@map("roles")
}

model UserRole {
  userId String @map("user_id")
  roleId String @map("role_id")

  user User @relation(fields: [userId], references: [userId], onDelete: Cascade)
  role Role @relation(fields: [roleId], references: [roleId], onDelete: Cascade)

  @@id([userId, roleId])
  @@map("user_roles")
}

model Menu {
  menuId    String  @id @default(uuid()) @map("menu_id")
  menuCode  String  @unique @map("menu_code")
  menuName  String  @map("menu_name")
  path      String?
  sortOrder Int     @default(0) @map("sort_order")
  isActive  Boolean @default(true) @map("is_active")

  roleMenus RoleMenu[]
  userOverrides UserMenuOverride[]

  @@map("menus")
}

model RoleMenu {
  roleId  String @map("role_id")
  menuId  String @map("menu_id")
  canView Boolean @default(true) @map("can_view")
  canEdit Boolean @default(false) @map("can_edit")

  role Role @relation(fields: [roleId], references: [roleId], onDelete: Cascade)
  menu Menu @relation(fields: [menuId], references: [menuId], onDelete: Cascade)

  @@id([roleId, menuId])
  @@map("role_menus")
}

model UserMenuOverride {
  userId    String  @map("user_id")
  menuId    String  @map("menu_id")
  allowView Boolean? @map("allow_view")
  allowEdit Boolean? @map("allow_edit")

  user User @relation(fields: [userId], references: [userId], onDelete: Cascade)
  menu Menu @relation(fields: [menuId], references: [menuId], onDelete: Cascade)

  @@id([userId, menuId])
  @@map("user_menu_overrides")
}

model Team {
  teamId   String  @id @default(uuid()) @map("team_id")
  teamCode String? @unique @map("team_code")
  teamName String  @map("team_name")

  employees Employee[]

  @@map("teams")
}

model Employee {
  employeeId String  @id @default(uuid()) @map("employee_id")
  empCode    String? @unique @map("emp_code")
  firstName  String  @map("first_name")
  lastName   String  @map("last_name")
  nickName   String? @map("nick_name")
  phone      String?
  email      String?
  roleTitle  String? @map("role_title")
  teamId     String? @map("team_id")
  isActive   Boolean @default(true) @map("is_active")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @default(now()) @updatedAt @map("updated_at")

  team Team? @relation(fields: [teamId], references: [teamId])

  users User[]
  leaveRequests LeaveRequest[]
  rosterAssignments RosterAssignment[]
  holidayLedger HolidayCreditLedger[]

  @@map("employees")
}

model EventType {
  eventTypeId            String  @id @default(uuid()) @map("event_type_id")
  eventCode              String  @unique @map("event_code")
  eventName              String  @map("event_name")
  colorHex               String  @default("#3b82f6") @map("color_hex")
  isWork                 Boolean @default(true) @map("is_work")
  isHoliday              Boolean @default(false) @map("is_holiday")
  defaultDurationMinutes Int     @default(0) @map("default_duration_minutes")
  isActive               Boolean @default(true) @map("is_active")
  sortOrder              Int     @default(0) @map("sort_order")

  rosterEntries RosterEntry[]

  @@map("event_types")
}

model ShiftSlot {
  shiftSlotId String  @id @default(uuid()) @map("shift_slot_id")
  slotCode    String? @unique @map("slot_code")
  slotName    String  @map("slot_name")
  startTime   DateTime  @map("start_time") @db.Time
  endTime     DateTime  @map("end_time") @db.Time
  minStaff    Int     @default(0) @map("min_staff")
  maxStaff    Int     @default(0) @map("max_staff")
  sortOrder   Int     @default(0) @map("sort_order")
  isActive    Boolean @default(true) @map("is_active")

  rosterEntries RosterEntry[]

  @@map("shift_slots")
}

model CompanyHoliday {
  holidayId   String  @id @default(uuid()) @map("holiday_id")
  holidayDate DateTime @db.Date @map("holiday_date")
  holidayName String  @map("holiday_name")
  holidayType String  @default("ORG") @map("holiday_type")
  isActive    Boolean @default(true) @map("is_active")

  @@unique([holidayDate, holidayName])
  @@map("company_holidays")
}

model LeaveType {
  leaveTypeId String  @id @default(uuid()) @map("leave_type_id")
  leaveCode   String  @unique @map("leave_code")
  leaveName   String  @map("leave_name")
  isActive    Boolean @default(true) @map("is_active")

  leaveRequests LeaveRequest[]

  @@map("leave_types")
}

model LeaveRequest {
  leaveRequestId String  @id @default(uuid()) @map("leave_request_id")
  employeeId     String  @map("employee_id")
  leaveTypeId    String  @map("leave_type_id")
  dateFrom       DateTime @db.Date @map("date_from")
  dateTo         DateTime @db.Date @map("date_to")
  reason         String? @db.Text
  status         String  @default("PENDING")
  requestedAt    DateTime @default(now()) @map("requested_at")
  decidedAt      DateTime? @map("decided_at")
  decidedByUser  String? @map("decided_by_user")
  decisionNote   String? @db.Text @map("decision_note")

  employee Employee @relation(fields: [employeeId], references: [employeeId])
  leaveType LeaveType @relation(fields: [leaveTypeId], references: [leaveTypeId])
  decider User? @relation(fields: [decidedByUser], references: [userId])

  holidayLedger HolidayCreditLedger[]

  @@index([employeeId, dateFrom, dateTo])
  @@index([status])
  @@map("leave_requests")
}

model RosterEntry {
  entryId     String   @id @default(uuid()) @map("entry_id")
  entryDate   DateTime @db.Date @map("entry_date")
  eventTypeId String   @map("event_type_id")
  shiftSlotId String?  @map("shift_slot_id")
  startAt     DateTime @map("start_at")
  endAt       DateTime @map("end_at")
  note        String?  @db.Text
  createdBy   String?  @map("created_by")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at")

  eventType EventType @relation(fields: [eventTypeId], references: [eventTypeId])
  shiftSlot ShiftSlot? @relation(fields: [shiftSlotId], references: [shiftSlotId])
  creator   User? @relation(fields: [createdBy], references: [userId])

  assignments RosterAssignment[]
  holidayLedger HolidayCreditLedger[]

  @@index([entryDate])
  @@index([startAt, endAt])
  @@map("roster_entries")
}

model RosterAssignment {
  entryId    String  @map("entry_id")
  employeeId String  @map("employee_id")
  assignedAt DateTime @default(now()) @map("assigned_at")
  assignedBy String?  @map("assigned_by")

  entry    RosterEntry @relation(fields: [entryId], references: [entryId], onDelete: Cascade)
  employee Employee @relation(fields: [employeeId], references: [employeeId], onDelete: Restrict)
  assigner User? @relation(fields: [assignedBy], references: [userId])

  @@id([entryId, employeeId])
  @@index([employeeId])
  @@map("roster_assignments")
}

model HolidayCreditLedger {
  ledgerId       String   @id @default(uuid()) @map("ledger_id")
  employeeId     String   @map("employee_id")
  entryId        String?  @map("entry_id")
  leaveRequestId String?  @map("leave_request_id")
  minutesDelta   Int      @map("minutes_delta")
  reason         String?
  createdAt      DateTime @default(now()) @map("created_at")

  employee Employee @relation(fields: [employeeId], references: [employeeId], onDelete: Cascade)
  entry    RosterEntry? @relation(fields: [entryId], references: [entryId])
  leaveRequest LeaveRequest? @relation(fields: [leaveRequestId], references: [leaveRequestId])

  @@index([employeeId, createdAt])
  @@map("holiday_credit_ledger")
}

model Setting {
  settingKey   String @id @map("setting_key")
  settingValue String @map("setting_value")

  @@map("settings")
}
